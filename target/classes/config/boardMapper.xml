<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">
	<resultMap id="boardContent" type="dto.BoardDTO" >
    	<result property="board_content" column="board_content" jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>

	<select id="selList" resultType="dto.BoardDTO" resultMap="boardContent" parameterType="hashmap">
		select b.*
		from(select rownum rm, a.*
			 from(select board_num, m.user_code, board_movie, board_subject, board_content, board_like, board_share, board_reply,
				  to_char(board_date, 'YYYY-MM-DD HH24:MI:SS') as board_date, board_hashtag, board_photo,
				  user_nickname, user_photo,
				  (select case when count(*) > 0 then 1 else 0 end 
        		   from moons_like
				   where user_code=#{my_code} and board_num=m.board_num) as isLike,
				  (select case when count(*) > 0 then 1 else 0 end 
        		   from moons_share
				   where user_code=#{my_code} and board_num=m.board_num) as isShare
				  from moons_board m, moons_user u
				  where m.user_code=u.user_code and m.user_code=#{writer_code}
				  order by board_date desc)a)b
		<![CDATA[where rm>#{start} and rm<=#{start}+8]]>
	</select>
	
	<select id="selGrid" resultType="dto.BoardDTO" parameterType="hashmap">
		select b.*
		from(select rownum rm, a.*
			 from(select board_num, board_subject, board_photo
				  from moons_board
				  where user_code=#{writer_code}
				  order by board_date desc)a)b
		<![CDATA[where rm>#{start} and rm<=#{start}+8]]>
	</select>
	
	<select id="likeCount" parameterType="dto.BoardDTO" resultType="int">
		select count(*) from moons_like where board_num=#{board_num}
	</select>
	
	<insert id="insLike" parameterType="dto.BoardDTO">
		insert into moons_like values(#{user_code},#{board_num},SYSDATE)
	</insert>
	
	<delete id="delLike" parameterType="dto.BoardDTO">
		delete from moons_like where user_code=#{user_code} and board_num=#{board_num}
	</delete>
	
	<select id="shareCount" parameterType="dto.BoardDTO" resultType="int">
		select count(*) from moons_share where board_num=#{board_num}
	</select>
	
	<insert id="insShare" parameterType="dto.BoardDTO">
		insert into moons_share values(#{user_code},#{board_num},SYSDATE)
	</insert>
	
	<delete id="delShare" parameterType="dto.BoardDTO">
		delete from moons_share where user_code=#{user_code} and board_num=#{board_num}
	</delete>
	
	<insert id="post" parameterType="dto.BoardDTO">	
		insert into moons_board values(moons_board_num_seq.nextval,#{user_code},'movie',#{board_subject},#{board_content},0,0,0,sysdate,'#즐거움',#{board_photo},1)
		<selectKey resultType="int" keyProperty="board_num" order="AFTER">
	        SELECT LAST_NUMBER-1
	        FROM USER_SEQUENCES
	        WHERE SEQUENCE_NAME = 'MOONS_BOARD_NUM_SEQ'
	    </selectKey>
	</insert>

	<insert id="tempFile" parameterType="String">
		insert into moons_file values(NULL,#{file_name})
	</insert>
	
	<update id="postFile" parameterType="hashmap">
		<foreach collection="fileList" item="item" separator=";" open="declare begin" close="; end;">
			update moons_file set board_num=#{board_num} where board_num is NULL and file_name=#{item}
		</foreach>
	</update>
	
	<select id="selFile" parameterType="int" resultType="String">
		select file_name from moons_file where board_num=#{board_num}
	</select>
	
	<delete id="delPost" parameterType="int">
		delete from moons_board where board_num=#{board_num}
	</delete>

	<select id="selDetail" parameterType="hashmap" resultType="dto.BoardDTO">
		select board_num, m.user_code, board_movie, board_subject, board_content, board_like, board_share, board_reply,
		to_char(board_date, 'YYYY-MM-DD HH24:MI:SS') as board_date, board_hashtag, board_photo,
		u.user_nickname, u.user_photo, u.user_introduce,
		(select case when count(*) > 0 then 1 else 0 end 
		 from moons_like
		 where user_code=#{user_code} and board_num=m.board_num) as isLike,
		(select case when count(*) > 0 then 1 else 0 end 
		 from moons_share
		 where user_code=#{user_code} and board_num=m.board_num) as isShare
		from moons_board m, moons_user u
		where board_num=#{board_num} and m.user_code=u.user_code
	</select>
	
	<select id="selWriter" parameterType="dto.BoardDTO" resultType="int">
		select user_code from moons_board where board_num=#{board_num}
	</select>
	
	<select id="postCount" parameterType="int" resultType="int">
		select count(*) from moons_board where user_code=#{user_code}
	</select>
</mapper>   